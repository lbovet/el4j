<?xml version="1.0"?>
<project name="project" basedir="." 
    xmlns:antcontrib="antlib:net.sf.antcontrib">
    <description>
        Script to check if a given file contains an expected string. In some 
        cases it is necessary to notify by mail.
        
        Needed properties to override:
           * log.output.file
              * File name of the output file that contains junit console output
           * log.output.dir
              * Directory where the log.output.file is
           * test.set
              * Set that ran, i.e. framework
           * test.profile
              * Profile that was tested, i.e. tomcat-jboss
           * test.report.website.url
              * Url to the generated website
           * test.report.xml
              * Location of the testsuites xml report
        
    </description>

    <property name="temp.path" value="temp"/>
    <property name="log.output.file" value="somefile.log"/>
    <property name="log.output.dir" value="${basedir}"/>
    
    <property name="mail.host" value="${MailLogger.mailhost}"/>
    <property name="mail.from" value="${MailLogger.replyto}"/>
    <property name="mail.to" value="${MailLogger.failure.to}"/>
    
    <property name="test.set" value="unknown-test-set"/>
    <property name="test.profile" value="unknown-test-profile"/>
    <property name="test.report.website.url" value="http://unknown/website"/>
    <property name="test.report.xml" value="/unknown/junit-report.xml"/>

    
    <target name="checkJunit" description="">
        <!-- 
            Tests if the log file contains any junit tests. 
            If not a mail will be sent.
        -->
        <delete quiet="true" includeEmptyDirs="true">
            <fileset dir="${temp.path}" defaultexcludes="false"/>
        </delete>
        <mkdir dir="${temp.path}"/>
        <copy todir="${temp.path}">
            <fileset dir="${log.output.dir}" includes="${log.output.file}">
                <containsregexp expression="Tests\ run:\ [1-9][0-9]*"/>
            </fileset>
        </copy>
        
        <antcontrib:if>
            <filesmatch file1="${log.output.dir}/${log.output.file}"
                file2="${temp.path}/${log.output.file}"/>
            <antcontrib:then>
                <antcall target="checkJunit.internal" inheritall="true"/>
            </antcontrib:then>
            <antcontrib:else>
                <mail from="${mail.from}"
                    tolist="${mail.to}"
                    mailhost="${mail.host}"
                    subject="EL4J autotests not executed (${test.set}, ${test.profile})!">
<message>Autotests not executed for project ${test.set} with profile ${test.profile}!
Please check configuration on leaffy.
</message>
                </mail>
            </antcontrib:else>
        </antcontrib:if>
    </target>
    
    
    
    <target name="checkJunit.internal">
        <!--
            Tests if junit tests where failed or not. A mail will be sent with
            the corresponding message.
        -->
        <delete quiet="true" includeEmptyDirs="true">
            <fileset dir="${temp.path}" defaultexcludes="false"/>
        </delete>
        <mkdir dir="${temp.path}"/>
        <copy todir="${temp.path}">
            <fileset dir="${log.output.dir}" includes="${log.output.file}">
                <containsregexp expression="Tests\ run:\ [0-9]+,.*((Failures:\ [1-9][0-9]*)|(Errors: [1-9][0-9]*))"/>
            </fileset>
        </copy>
        
        <antcontrib:if>
            <filesmatch file1="${log.output.dir}/${log.output.file}"
                file2="${temp.path}/${log.output.file}"/>
            <antcontrib:then>
                <mail from="${mail.from}"
                    tolist="${mail.to}"
                    mailhost="${mail.host}"
                    subject="EL4J autotests failed (${test.set}, ${test.profile})">
<message>Autotests failed for project ${test.set} with profile ${test.profile}.
For detailed junit reports see ${test.report.xml} on leaffy.
For further information please have a look at ${test.report.website.url}.
</message>
                </mail>
            </antcontrib:then>
            <antcontrib:else>
                <mail from="${mail.from}"
                    tolist="${mail.to}"
                    mailhost="${mail.host}"
                    subject="EL4J autotests succeeded (${test.set}, ${test.profile})">
<message>Autotests succeeded for project ${test.set} with profile ${test.profile}.
For detailed junit reports see ${test.report.xml} on leaffy.
For further information please have a look at ${test.report.website.url}.
</message>
                </mail>
            </antcontrib:else>
        </antcontrib:if>
    </target>
</project>

