<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="refdb-core">
    <!-- Version: $Revision$ -->
    <!-- URL: $URL$ -->
    <!-- Date: $Date$ -->
    <!-- Author: $Author$ -->

    <!-- 
        Annotation related invocations
    -->

    <insert id="insertAnnotation">
        insert into ANNOTATIONS (KEYTOREFERENCE, ANNOTATOR, GRADE, 
            CONTENT, WHENINSERTED, OPTIMISTICLOCKINGVERSION) 
            values (#keyToReference#, #annotator#, 
                #grade#, #content,handler=clobHandler#, #whenInserted#, 
                #optimisticLockingVersion#)
        <selectKey resultClass="int" keyProperty="key">
           SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>

    <update id="updateAnnotation">
        update ANNOTATIONS set KEYTOREFERENCE=#keyToReference#, 
            <dynamic>
                <isNotNull property="annotator">
                    ANNOTATOR=#annotator#
                </isNotNull>
                <isNull property="annotator">
                    ANNOTATOR=null
                </isNull>
                ,
            </dynamic>
            GRADE=#grade#, CONTENT=#content,handler=clobHandler#, 
            OPTIMISTICLOCKINGVERSION=OPTIMISTICLOCKINGVERSION+1 
            where KEYID=#key# 
                and OPTIMISTICLOCKINGVERSION=#optimisticLockingVersion#
    </update>
</sqlMap>
