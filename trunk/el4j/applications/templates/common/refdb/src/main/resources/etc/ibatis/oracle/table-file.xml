<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="refdb-core">
	<!-- Version: $Revision$ -->
	<!-- URL: $URL$ -->
	<!-- Date: $Date$ -->
	<!-- Author: $Author$ -->

	<!--
		File related invocations
	-->
	<insert id="insertFile">
		<selectKey resultClass="int" keyProperty="key">
			select FILE_SEQUENCE.NEXTVAL AS KEY FROM DUAL
		</selectKey>
		insert into FILES (KEYID, KEYTOREFERENCE, NAME, MIMETYPE, CONTENTSIZE,
			CONTENT, OPTIMISTICLOCKINGVERSION)
			values (#key#, #keyToReference#, #name#, #mimeType#, #size#,
				#content,handler=blobHandler#, #optimisticLockingVersion#)
	</insert>

	<update id="updateFile">
		update FILES set KEYTOREFERENCE=#keyToReference#, NAME=#name#,
			MIMETYPE=#mimeType#, CONTENTSIZE=#size#,
			CONTENT=#content,handler=blobHandler#,
			OPTIMISTICLOCKINGVERSION=OPTIMISTICLOCKINGVERSION+1
			where KEYID=#key#
				and OPTIMISTICLOCKINGVERSION=#optimisticLockingVersion#
	</update>

	<update id="updateFileDescriptorView">
		update FILES set KEYTOREFERENCE=#keyToReference#, NAME=#name#,
			MIMETYPE=#mimeType#, CONTENTSIZE=#size#,
			OPTIMISTICLOCKINGVERSION=OPTIMISTICLOCKINGVERSION+1
			where KEYID=#key#
				and OPTIMISTICLOCKINGVERSION=#optimisticLockingVersion#
	</update>
</sqlMap>
