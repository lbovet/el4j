<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="refdb-core">
	<!-- Version: $Revision$ -->
	<!-- URL: $URL$ -->
	<!-- Date: $Date$ -->
	<!-- Author: $Author$ -->

	<!--
		File related invocations
	-->
	<!--
		ATTENTION: Dynamic parts are only used due to badly implemented jdbc
		driver from ibm, which does not support java.sql.Types.NULL!
	-->
	<insert id="insertFile">
		insert into FILES (KEYTOREFERENCE, NAME, MIMETYPE, CONTENTSIZE,
			CONTENT, OPTIMISTICLOCKINGVERSION)
			values (#keyToReference#,
				<dynamic>
					<isNotNull property="name">
						#name#
					</isNotNull>
					<isNull property="name">
						null
					</isNull>
					,
					<isNotNull property="mimeType">
						#mimeType#
					</isNotNull>
					<isNull property="mimeType">
						null
					</isNull>
					,
				</dynamic>
				#size#, #content,handler=blobHandler#,
				#optimisticLockingVersion#)
		<selectKey resultClass="int" keyProperty="key">
			values IDENTITY_VAL_LOCAL()
		</selectKey>
	</insert>

	<update id="updateFile">
		update FILES set KEYTOREFERENCE=#keyToReference#,
			<dynamic>
				<isNotNull property="name">
					NAME=#name#
				</isNotNull>
				<isNull property="name">
					NAME=null
				</isNull>
				,
				<isNotNull property="mimeType">
					MIMETYPE=#mimeType#
				</isNotNull>
				<isNull property="mimeType">
					MIMETYPE=null
				</isNull>
				,
			</dynamic>
			CONTENTSIZE=#size#, CONTENT=#content,handler=blobHandler#,
			OPTIMISTICLOCKINGVERSION=OPTIMISTICLOCKINGVERSION+1
			where KEYID=#key#
				and OPTIMISTICLOCKINGVERSION=#optimisticLockingVersion#
	</update>

	<update id="updateFileDescriptorView">
		update FILES set KEYTOREFERENCE=#keyToReference#, NAME=#name#,
			MIMETYPE=#mimeType#, CONTENTSIZE=#size#,
			OPTIMISTICLOCKINGVERSION=OPTIMISTICLOCKINGVERSION+1
			where KEYID=#key#
				and OPTIMISTICLOCKINGVERSION=#optimisticLockingVersion#
	</update>
</sqlMap>
