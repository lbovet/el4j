<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
	
<sqlMap namespace="refdb-core">
    <!-- Version: $Revision$ -->
    <!-- Source: $Source$ -->
    <!-- Date: $Date$ -->
    <!-- Author: $Author$ -->

    <!-- 
        Link related invocations
    -->
    <resultMap id="link" class="ch.elca.el4j.apps.refdb.dto.LinkDto">
        <result property="key" column="KEYID"/>
        <result property="name" column="NAME"/>
        <result property="hashValue" column="HASHVALUE"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="version" column="VERSION"/>
        <result property="incomplete" column="INCOMPLETE"/>
        <result property="whenInserted" column="WHENINSERTED"/>
        <result property="date" column="DOCUMENTDATE"/>
        <result property="url" column="URL"/>
        <result property="optimisticLockingVersion" 
            column="OPTIMISTICLOCKINGVERSION"/>
        <result property="keywords" column="KEYID" 
            select="getKeywordsByReferenceKey"/>
    </resultMap>
    <statement id="getLinkByKey" 
        parameterClass="int" resultMap="link">
        select KEYID, NAME, HASHVALUE, DESCRIPTION, VERSION, INCOMPLETE, 
            WHENINSERTED, DOCUMENTDATE, URL, OPTIMISTICLOCKINGVERSION 
            from LINKS, REFERENCESTABLE
                where KEYID=#value# 
                    and KEYID=KEYTOREFERENCE
    </statement>
    <statement id="getLinksByName" 
        parameterClass="java.lang.String" resultMap="link">
        select KEYID, NAME, HASHVALUE, DESCRIPTION, VERSION, INCOMPLETE, 
            WHENINSERTED, DOCUMENTDATE, URL, OPTIMISTICLOCKINGVERSION 
            from LINKS, REFERENCESTABLE
                where NAME=#value# 
                    and KEYID=KEYTOREFERENCE
    </statement>
    <statement id="getAllLinks" resultMap="link">
        select KEYID, NAME, HASHVALUE, DESCRIPTION, VERSION, INCOMPLETE, 
            WHENINSERTED, DOCUMENTDATE, URL, OPTIMISTICLOCKINGVERSION 
            from LINKS, REFERENCESTABLE
                where KEYID=KEYTOREFERENCE
    </statement>
    
    <select id="searchLinks" resultMap="link" parameterClass="list">
        select distinct KEYID, NAME, HASHVALUE, DESCRIPTION, VERSION, INCOMPLETE, 
            WHENINSERTED, DOCUMENTDATE, URL, OPTIMISTICLOCKINGVERSION 
            from REFERENCESTABLE, LINKS
                where KEYID=KEYTOREFERENCE
        <!--
            HACK!
            This will be replaced by an easier solution.
            (MZE, 22/02/2006)
        -->
        <iterate prepend="and" conjunction="and">
            <isEqual property="[].type" compareValue="comparisonBoolean">
                <isEqual property="[].field" compareValue="incomplete">
                    INCOMPLETE=#[].booleanValue#
                </isEqual>
            </isEqual>
            <isEqual property="[].type" compareValue="like">
                <isEqual property="[].field" compareValue="name">
                    <isEqual property="[].caseSensitive" compareValue="true">
                        NAME like #[].stringValue#
                    </isEqual>
                    <isNotEqual property="[].caseSensitive" compareValue="true">
                        upper(NAME) like upper(#[].stringValue#)
                    </isNotEqual>
                </isEqual>
                <isEqual property="[].field" compareValue="description">
                    <isEqual property="[].caseSensitive" compareValue="true">
                        DESCRIPTION like #[].stringValue#
                    </isEqual>
                    <isNotEqual property="[].caseSensitive" compareValue="true">
                        upper(DESCRIPTION) like upper(#[].stringValue#)
                    </isNotEqual>
                </isEqual>
            </isEqual>
        </iterate>
        <iterate prepend="and"
            conjunction="and" >
            <isEqual property="[].type" compareValue="comparisonInteger">
                <isEqual property="[].field" compareValue="keywords">
                    KEYID in (
                        select KEYREFERENCE from REFERENCEKEYWORDRELATIONSHIPS 
                            where KEYKEYWORD=#[].integerValue#)
                </isEqual>
            </isEqual>
        </iterate>
        order by NAME, DESCRIPTION
    </select>

    <delete id="deleteLink" parameterClass="int">
        delete from LINKS where KEYTOREFERENCE=#value#
    </delete>
</sqlMap>
