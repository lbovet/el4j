<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com/DTD SQL Map 2.0//EN"
	"http://www.ibatis.com/dtd/sql-map-2.dtd">
	
<sqlMap namespace="refdb-core">
    <!-- Version: $Revision$ -->
    <!-- Source: $Source$ -->
    <!-- Date: $Date$ -->
    <!-- Author: $Author$ -->

    <!-- 
        Book related invocations
    -->
    <resultMap id="book" 
        class="ch.elca.el4j.apps.refdb.dto.BookDto">
        <result property="key" column="KEYID"/>
        <result property="name" column="NAME"/>
        <result property="hashValue" column="HASHVALUE"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="version" column="VERSION"/>
        <result property="incomplete" column="INCOMPLETE"/>
        <result property="whenInserted" column="WHENINSERTED"/>
        <result property="date" column="DOCUMENTDATE"/>
        <result property="authorName" column="AUTHORNAME"/>
        <result property="publisher" column="PUBLISHER"/>
        <result property="pageNum" column="PAGENUM"/>
        <result property="isbnNumber" column="ISBNNUMBER"/>
        <result property="optimisticLockingVersion" 
            column="OPTIMISTICLOCKINGVERSION"/>
        <result property="keywords" column="KEYID" 
            select="getKeywordsByReferenceKey"/>
    </resultMap>
    <statement id="getBookByKey" 
        parameterClass="int" resultMap="book">
        select KEYID, NAME, HASHVALUE, DESCRIPTION, VERSION, INCOMPLETE, 
            WHENINSERTED, DOCUMENTDATE, AUTHORNAME, PUBLISHER, PAGENUM, 
            ISBNNUMBER, OPTIMISTICLOCKINGVERSION from BOOKS, REFERENCESTABLE
                where KEYID=#value# 
                    and KEYID=KEYTOREFERENCE
    </statement>
    <statement id="getBooksByName" 
        parameterClass="java.lang.String" resultMap="book">
        select KEYID, NAME, HASHVALUE, DESCRIPTION, VERSION, INCOMPLETE, 
            WHENINSERTED, DOCUMENTDATE, AUTHORNAME, PUBLISHER, PAGENUM, 
            ISBNNUMBER, OPTIMISTICLOCKINGVERSION from BOOKS, REFERENCESTABLE
                where NAME=#value# 
                    and KEYID=KEYTOREFERENCE
    </statement>
    <statement id="getAllBooks" resultMap="book">
        select KEYID, NAME, HASHVALUE, DESCRIPTION, VERSION, INCOMPLETE, 
            WHENINSERTED, DOCUMENTDATE, AUTHORNAME, PUBLISHER, PAGENUM, 
            ISBNNUMBER, OPTIMISTICLOCKINGVERSION from BOOKS, REFERENCESTABLE
                where KEYID=KEYTOREFERENCE
    </statement>
    <statement id="searchBooksWithFieldsNameDescription" 
        resultMap="book">
        select KEYID, NAME, HASHVALUE, DESCRIPTION, VERSION, INCOMPLETE, 
            WHENINSERTED, DOCUMENTDATE, AUTHORNAME, PUBLISHER, PAGENUM, 
            ISBNNUMBER, OPTIMISTICLOCKINGVERSION from BOOKS, REFERENCESTABLE
                where KEYID=KEYTOREFERENCE
        <dynamic>
            <isNotEmpty prepend="and" property="name">
                lower(NAME) like '%$name$%'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="description">
                lower(DESCRIPTION) like '%$description$%'
            </isNotEmpty>
        </dynamic>
        order by NAME, DESCRIPTION
    </statement>
    <statement id="searchBooksWithFieldsNameDescriptionIncomplete" 
        resultMap="book">
        select KEYID, NAME, HASHVALUE, DESCRIPTION, VERSION, INCOMPLETE, 
            WHENINSERTED, DOCUMENTDATE, AUTHORNAME, PUBLISHER, PAGENUM, 
            ISBNNUMBER, OPTIMISTICLOCKINGVERSION from BOOKS, REFERENCESTABLE
                where KEYID=KEYTOREFERENCE and INCOMPLETE=#incomplete#
        <dynamic>
            <isNotEmpty prepend="and" property="name">
                lower(NAME) like '%$name$%'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="description">
                lower(DESCRIPTION) like '%$description$%'
            </isNotEmpty>
        </dynamic>
        order by NAME, DESCRIPTION
    </statement>

    <delete id="deleteBook" parameterClass="int">
        delete from BOOKS where KEYTOREFERENCE=#value#
    </delete>
</sqlMap>
